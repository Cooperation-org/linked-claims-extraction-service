{% extends "base.html" %}

{% block title %}{{ document.original_filename }} - Claims Review{% endblock %}

{% block page_title %}Review & Edit Claims{% endblock %}

{% block content %}
<style>
/* Document info styling */
.document-info-card {
    background: white;
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 1.5rem;
}

.info-item label {
    font-size: 0.875rem;
    color: #666;
    display: block;
    margin-bottom: 0.25rem;
}

.info-item .value {
    font-size: 1rem;
    color: #333;
}

/* Claim cards */
.claim-card {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    transition: box-shadow 0.2s;
}

.claim-card:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.claim-card.needs-verification {
    border-left: 4px solid #ffc107;
}

.claim-field {
    margin-bottom: 1rem;
}

.field-label {
    font-size: 0.875rem;
    font-weight: 600;
    color: #666;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.url-field {
    display: flex;
    align-items: start;
    gap: 0.5rem;
}

.url-display {
    flex: 1;
    padding: 0.5rem;
    background: #f5f5f5;
    border-radius: 4px;
    font-family: monospace;
    font-size: 0.875rem;
    word-break: break-all;
    cursor: pointer;
}

.url-display:hover {
    background: #e8e8e8;
}

.url-status {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
}

.url-verified {
    background: #d4edda;
    color: #155724;
}

.url-needs-verification {
    background: #fff3cd;
    color: #856404;
}

.url-invalid {
    background: #f8d7da;
    color: #721c24;
}

.url-edit-form {
    display: none;
    margin-top: 0.5rem;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 4px;
}

.url-edit-form.active {
    display: block;
}

.url-input {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-family: monospace;
    font-size: 0.875rem;
    margin-bottom: 0.5rem;
}

.url-suggestions {
    margin-top: 0.5rem;
}

.suggestion-label {
    font-size: 0.75rem;
    color: #666;
    margin-bottom: 0.25rem;
}

.suggestion-item {
    display: block;
    padding: 0.375rem 0.75rem;
    margin-bottom: 0.25rem;
    background: white;
    border: 1px solid #ddd;
    border-radius: 4px;
    color: #2196F3;
    text-decoration: none;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s;
}

.suggestion-item:hover {
    background: #e3f2fd;
    border-color: #2196F3;
}

.claim-metadata {
    display: flex;
    gap: 1rem;
    font-size: 0.875rem;
    color: #666;
    padding-top: 0.5rem;
    margin-top: 0.5rem;
    border-top: 1px solid #f0f0f0;
}

.claim-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid #e0e0e0;
}

.action-buttons {
    display: flex;
    gap: 0.5rem;
}

.status-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 500;
}

.status-draft { background: #e3f2fd; color: #1976d2; }
.status-approved { background: #fff3cd; color: #856404; }
.status-published { background: #d4edda; color: #155724; }
.status-rejected { background: #ffebee; color: #c62828; }

/* Claim type badges */
.claim-type {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.2rem 0.5rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
    text-transform: lowercase;
}

.claim-type-impact { background: #e8f5e9; color: #2e7d32; }
.claim-type-rated { background: #fff3e0; color: #e65100; }
.claim-type-same_as { background: #e3f2fd; color: #1565c0; }
.claim-type-validated { background: #f3e5f5; color: #6a1b9a; }
.claim-type-related_to { background: #e0f2f1; color: #00695c; }
.claim-type-owns { background: #fce4ec; color: #c2185b; }
.claim-type-performed { background: #f1f8e9; color: #558b2f; }
</style>

<!-- Document Info -->
<div class="document-info-card">
    <div class="info-grid">
        <div class="info-item">
            <label>Document</label>
            <div class="value">{{ document.original_filename }}</div>
        </div>
        <div class="info-item">
            <label>Status</label>
            <div class="value">
                <span class="status-badge status-{{ document.status }}">{{ document.status }}</span>
            </div>
        </div>
        <div class="info-item">
            <label>Public URL</label>
            <div class="value">
                <a href="{{ document.public_url }}" target="_blank" class="text-primary">{{ document.public_url }}</a>
            </div>
        </div>
        <div class="info-item">
            <label>Effective Date</label>
            <div class="value">{{ document.effective_date.strftime('%Y-%m-%d') }}</div>
        </div>
    </div>

    {% if document.status == 'completed' %}
    <div class="mt-3">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <strong>{{ claims|length }}</strong> claims extracted
                {% if claims|selectattr('claim_data.urls_need_verification', 'equalto', true)|list|length > 0 %}
                <span class="url-needs-verification ms-2">
                    <i class="fas fa-exclamation-triangle"></i>
                    {{ claims|selectattr('claim_data.urls_need_verification', 'equalto', true)|list|length }} need URL verification
                </span>
                {% endif %}
            </div>
            <div>
                {% if claims|selectattr('status', 'equalto', 'approved')|list %}
                <button class="btn btn-primary" onclick="publishClaims()">
                    <i class="fas fa-cloud-upload-alt me-2"></i>
                    Publish {{ claims|selectattr('status', 'equalto', 'approved')|list|length }} Approved Claims
                </button>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Claims List -->
<div class="claims-section">
    <h3 class="mb-3">Extracted Claims</h3>
    
    {% if claims %}
        {% for claim in claims %}
        <div class="claim-card {% if claim.claim_data.urls_need_verification %}needs-verification{% endif %}" id="claim-{{ loop.index0 }}">
            <!-- Subject -->
            <div class="claim-field">
                <div class="field-label">
                    Subject
                    {% if claim.claim_data.urls_need_verification %}
                        <span class="url-needs-verification">
                            <i class="fas fa-exclamation-circle"></i> Needs verification
                        </span>
                    {% endif %}
                </div>
                <div class="url-field">
                    <div class="url-display" onclick="editUrl({{ claim.id }}, {{ loop.index0 }}, 'subject')">
                        {{ claim.subject }}
                    </div>
                    <button class="btn btn-sm btn-outline-secondary" onclick="editUrl({{ claim.id }}, {{ loop.index0 }}, 'subject')">
                        <i class="fas fa-edit"></i>
                    </button>
                </div>
                <div class="url-edit-form" id="edit-subject-{{ loop.index0 }}">
                    <input type="url" 
                           class="url-input" 
                           id="input-subject-{{ loop.index0 }}" 
                           value="{{ claim.subject }}"
                           placeholder="https://...">
                    {% if claim.claim_data.subject_suggested %}
                    <div class="url-suggestions">
                        <div class="suggestion-label">Suggested URLs:</div>
                        <a class="suggestion-item" onclick="applyUrl({{ loop.index0 }}, 'subject', '{{ claim.claim_data.subject_suggested }}')">
                            {{ claim.claim_data.subject_suggested }}
                        </a>
                        {% if claim.claim_data.subject_entity_type %}
                        <small class="text-muted">Detected as: {{ claim.claim_data.subject_entity_type }}</small>
                        {% endif %}
                    </div>
                    {% endif %}
                    <div class="mt-2">
                        <button class="btn btn-sm btn-primary" onclick="saveUrl({{ claim.id }}, {{ loop.index0 }}, 'subject')">Save</button>
                        <button class="btn btn-sm btn-secondary" onclick="editUrl({{ claim.id }}, {{ loop.index0 }}, 'subject')">Cancel</button>
                    </div>
                </div>
            </div>

            <!-- Statement -->
            <div class="claim-field">
                <div class="field-label">Statement</div>
                <div class="field-value">{{ claim.statement }}</div>
            </div>

            <!-- Object (if present) -->
            {% if claim.object %}
            <div class="claim-field">
                <div class="field-label">Object</div>
                <div class="url-field">
                    <div class="url-display" onclick="editUrl({{ claim.id }}, {{ loop.index0 }}, 'object')">
                        {{ claim.object }}
                    </div>
                    <button class="btn btn-sm btn-outline-secondary" onclick="editUrl({{ claim.id }}, {{ loop.index0 }}, 'object')">
                        <i class="fas fa-edit"></i>
                    </button>
                </div>
                <div class="url-edit-form" id="edit-object-{{ loop.index0 }}">
                    <input type="url" 
                           class="url-input" 
                           id="input-object-{{ loop.index0 }}" 
                           value="{{ claim.object }}"
                           placeholder="https://...">
                    {% if claim.claim_data.object_suggested %}
                    <div class="url-suggestions">
                        <div class="suggestion-label">Suggested URLs:</div>
                        <a class="suggestion-item" onclick="applyUrl({{ loop.index0 }}, 'object', '{{ claim.claim_data.object_suggested }}')">
                            {{ claim.claim_data.object_suggested }}
                        </a>
                        {% if claim.claim_data.object_entity_type %}
                        <small class="text-muted">Detected as: {{ claim.claim_data.object_entity_type }}</small>
                        {% endif %}
                    </div>
                    {% endif %}
                    <div class="mt-2">
                        <button class="btn btn-sm btn-primary" onclick="saveUrl({{ claim.id }}, {{ loop.index0 }}, 'object')">Save</button>
                        <button class="btn btn-sm btn-secondary" onclick="editUrl({{ claim.id }}, {{ loop.index0 }}, 'object')">Cancel</button>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Additional claim data -->
            {% if claim.claim_data.amt %}
            <div class="claim-field">
                <div class="field-label">Amount</div>
                <div class="field-value">{{ claim.claim_data.amt }} {{ claim.claim_data.unit or '' }}</div>
            </div>
            {% endif %}

            <!-- Metadata -->
            <div class="claim-metadata">
                <span><i class="fas fa-file-alt"></i> Page {{ claim.page_number }}</span>
                {% if claim.claim_data.claim %}
                <span class="claim-type claim-type-{{ claim.claim_data.claim|replace(' ', '_') }}">
                    <i class="fas fa-tag"></i> {{ claim.claim_data.claim }}
                </span>
                {% endif %}
                {% if claim.claim_data.confidence %}
                <span><i class="fas fa-chart-line"></i> Confidence: {{ (claim.claim_data.confidence * 100)|round }}%</span>
                {% endif %}
                {% if claim.claim_data.howKnown %}
                <span><i class="fas fa-info-circle"></i> How Known: {{ claim.claim_data.howKnown }}</span>
                {% endif %}
            </div>

            <!-- Actions -->
            <div class="claim-actions">
                <span class="status-badge status-{{ claim.status }}">{{ claim.status }}</span>
                <div class="action-buttons">
                    {% if claim.status == 'draft' %}
                    <button class="btn btn-sm btn-success" onclick="approveClaim({{ claim.id }})">
                        <i class="fas fa-check me-1"></i> Approve
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="rejectClaim({{ claim.id }})">
                        <i class="fas fa-times me-1"></i> Reject
                    </button>
                    {% elif claim.status == 'published' and claim.linkedtrust_claim_url %}
                    <a href="{{ claim.linkedtrust_claim_url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-external-link-alt me-1"></i> View on LinkedTrust
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="text-center py-5 text-muted">
            {% if document.status == 'pending' %}
                <i class="fas fa-hourglass-half fa-3x mb-3"></i>
                <p>Document is queued for processing...</p>
            {% elif document.status == 'processing' %}
                <i class="fas fa-spinner fa-spin fa-3x mb-3"></i>
                <p>Extracting claims from document...</p>
                <p class="small">This page will refresh automatically</p>
            {% elif document.status == 'failed' %}
                <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                <p>Failed to extract claims</p>
                <p class="small text-danger">{{ document.error_message }}</p>
                <button class="btn btn-primary mt-3" onclick="reprocessDocument()">
                    <i class="fas fa-redo me-2"></i> Try Again
                </button>
            {% else %}
                <i class="fas fa-file-excel fa-3x mb-3"></i>
                <p>No claims found in this document</p>
            {% endif %}
        </div>
    {% endif %}
</div>

<script>
const documentId = '{{ document.id }}';

// Auto-refresh if processing
{% if document.status in ['pending', 'processing'] %}
setTimeout(() => location.reload(), 5000);
{% endif %}

function editUrl(claimId, claimIndex, urlType) {
    const form = document.getElementById(`edit-${urlType}-${claimIndex}`);
    form.classList.toggle('active');
}

function applyUrl(claimIndex, urlType, url) {
    document.getElementById(`input-${urlType}-${claimIndex}`).value = url;
}

async function saveUrl(claimId, claimIndex, urlType) {
    const newUrl = document.getElementById(`input-${urlType}-${claimIndex}`).value.trim();
    
    if (!newUrl.startsWith('http://') && !newUrl.startsWith('https://')) {
        alert('URL must start with http:// or https://');
        return;
    }
    
    try {
        const response = await fetch(`/api/claims/${claimId}/update-url`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                urlType: urlType,
                newUrl: newUrl
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Update the display
            const urlDisplay = document.querySelector(`#claim-${claimIndex} .url-field .url-display`);
            if (urlType === 'object') {
                // Object is the second URL field
                const objectFields = document.querySelectorAll(`#claim-${claimIndex} .url-field`);
                if (objectFields.length > 1) {
                    objectFields[1].querySelector('.url-display').textContent = newUrl;
                }
            } else {
                urlDisplay.textContent = newUrl;
            }
            
            // Remove the needs-verification indicator
            const card = document.getElementById(`claim-${claimIndex}`);
            card.classList.remove('needs-verification');
            const verificationBadge = card.querySelector('.url-needs-verification');
            if (verificationBadge) {
                verificationBadge.style.display = 'none';
            }
            
            editUrl(claimId, claimIndex, urlType);
        } else {
            alert(data.error || 'Failed to update URL');
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function approveClaim(claimId) {
    try {
        const response = await fetch(`/api/claims/${claimId}/approve`, {
            method: 'POST'
        });
        
        if (response.ok) {
            location.reload();
        } else {
            const data = await response.json();
            alert(data.error || 'Failed to approve claim');
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function rejectClaim(claimId) {
    try {
        const response = await fetch(`/api/claims/${claimId}/reject`, {
            method: 'POST'
        });
        
        if (response.ok) {
            location.reload();
        } else {
            const data = await response.json();
            alert(data.error || 'Failed to reject claim');
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function publishClaims() {
    if (!confirm('Publish all approved claims to LinkedTrust?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/document/${documentId}/publish`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const data = await response.json();
        
        if (response.ok) {
            alert(`Successfully published ${data.published} claims to LinkedTrust!`);
            setTimeout(() => location.reload(), 1000);
        } else {
            alert('Publishing failed: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function reprocessDocument() {
    if (!confirm('Reprocess this document? This will delete existing draft claims.')) {
        return;
    }
    
    try {
        const response = await fetch(`/document/${documentId}/reprocess`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        // Handle authentication errors
        if (response.status === 401) {
            alert('Your session has expired. Please log in again.');
            window.location.href = '/login';
            return;
        }
        
        // Check if response is JSON
        const contentType = response.headers.get("content-type");
        if (contentType && contentType.indexOf("application/json") !== -1) {
            const data = await response.json();
            if (response.ok && data.success) {
                location.reload();
            } else if (data.redirect) {
                window.location.href = data.redirect;
            } else {
                alert('Error: ' + (data.error || 'Failed to reprocess document'));
            }
        } else {
            // Response is not JSON (probably HTML error page)
            const text = await response.text();
            console.error('Non-JSON response:', text);
            alert(`Error: Server returned non-JSON response (status ${response.status}). Check console for details.`);
        }
    } catch (error) {
        console.error('Reprocess error:', error);
        alert('Error reprocessing document: ' + error.message);
    }
}
</script>
{% endblock %}
