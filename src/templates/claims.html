{% extends "base.html" %}

{% block title %}Claims - Claim Extractor{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Claims</h2>
    <div class="d-flex gap-2">
        <input type="text" class="form-control" placeholder="Search for Claims" value="{{ search_query }}" id="searchInput" style="width: 300px;">
    </div>
</div>

<!-- Filter Tabs -->
<ul class="nav nav-tabs mb-4">
    <li class="nav-item">
        <a class="nav-link {% if status_filter == 'all' %}active{% endif %}" href="{{ url_for('view_claims', status='all', search=search_query) }}">
            All Claims
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link {% if status_filter == 'draft' %}active{% endif %}" href="{{ url_for('view_claims', status='draft', search=search_query) }}">
            Draft
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link {% if status_filter == 'published' %}active{% endif %}" href="{{ url_for('view_claims', status='published', search=search_query) }}">
            Published
        </a>
    </li>
</ul>

<p class="text-muted">{{ total_count }} claims found</p>

<!-- Claims List -->
{% for claim_id, data in extracted_claims.items() %}
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <div>
            <h6 class="mb-1">{{ data.original_filename }} ({{ data.claims|length }})</h6>
            <small class="text-muted">
                Claim: Uploaded, {{ data.upload_time[:10] }}
            </small>
            <br>
            <small class="text-muted">
                Claim extracted from uploaded PDF file: {{ data.filename }}
            </small>
        </div>
        <div class="d-flex gap-2">
            <!-- Publish All Button -->
            <button class="btn btn-publish" onclick="publishAllClaims('{{ claim_id }}')">
                <i class="fas fa-paper-plane me-2"></i>
                Publish All to LinkedTrust
            </button>
        </div>
    </div>
    <div class="card-body">
        <div id="claims-{{ claim_id }}">
            {% for claim in data.claims %}
            <div class="border-start border-3 {% if claim.get('status') == 'published' %}border-success{% elif claim.get('status') == 'failed' %}border-danger{% else %}border-info{% endif %} ps-3 mb-3" id="claim-{{ claim_id }}-{{ claim.get('claim_index', loop.index0) }}">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <strong>Subject:</strong> 
                        <span id="subject-display-{{ claim_id }}-{{ claim.get('claim_index', loop.index0) }}">{{ claim.get('subject', 'N/A') }}</span>
                        {% if claim.get('urls_need_verification') and claim.get('subject_suggested') %}
                        <span class="badge bg-warning ms-2" title="This URL was AI-generated and needs verification">
                            <i class="fas fa-exclamation-triangle me-1"></i>Suggested URL
                        </span>
                        <button class="btn btn-sm btn-outline-primary ms-2" onclick="showUrlEditor('{{ claim_id }}', {{ claim.get('claim_index', loop.index0) }}, 'subject', '{{ claim.get('subject', '') }}', '{{ claim.get('subject_entity_type', '') }}')">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        {% endif %}
                        <br>
                        <strong>Statement:</strong> {{ claim.get('statement', claim.get('description', 'N/A')) }}<br>
                        <strong>Object:</strong> 
                        <span id="object-display-{{ claim_id }}-{{ claim.get('claim_index', loop.index0) }}">{{ claim.get('object', claim.get('description', 'N/A')) }}</span>
                        {% if claim.get('urls_need_verification') and claim.get('object_suggested') %}
                        <span class="badge bg-warning ms-2" title="This URL was AI-generated and needs verification">
                            <i class="fas fa-exclamation-triangle me-1"></i>Suggested URL
                        </span>
                        <button class="btn btn-sm btn-outline-primary ms-2" onclick="showUrlEditor('{{ claim_id }}', {{ claim.get('claim_index', loop.index0) }}, 'object', '{{ claim.get('object', '') }}', '{{ claim.get('object_entity_type', '') }}')">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        {% endif %}
                        <br>
                        <strong>Aspect:</strong> {{ claim.get('aspect', 'N/A') }}<br>
                        <strong>How Known:</strong> {{ claim.get('howKnown', 'N/A') }}
                        
                        {% if claim.get('status') == 'published' %}
                        <br><strong>LinkedTrust ID:</strong> 
                        <span class="badge bg-success">{{ claim.get('linkedtrust_id', 'N/A') }}</span>
                        <br><small class="text-muted">Published: {{ claim.get('published_at', '')[:16] }}</small>
                        {% elif claim.get('status') == 'failed' %}
                        <br><strong>Error:</strong> 
                        <span class="text-danger small">{{ claim.get('error', 'Unknown error') }}</span>
                        <br><small class="text-muted">Failed: {{ claim.get('failed_at', '')[:16] }}</small>
                        {% endif %}
                    </div>
                    <div class="d-flex flex-column align-items-end gap-2">
                        <!-- Status Badge -->
                        <div>
                            {% if claim.get('status') == 'published' %}
                            <span class="badge bg-success">
                                <i class="fas fa-check-circle me-1"></i>Published
                            </span>
                            {% elif claim.get('status') == 'failed' %}
                            <span class="badge bg-danger">
                                <i class="fas fa-times-circle me-1"></i>Failed
                            </span>
                            {% else %}
                            <span class="badge bg-secondary">
                                <i class="fas fa-clock me-1"></i>Draft
                            </span>
                            {% endif %}
                        </div>
                        
                        <!-- Individual Publish Button -->
                        {% if claim.get('status') == 'draft' %}
                        <button class="btn btn-sm btn-outline-primary" 
                                onclick="publishSingleClaim('{{ claim_id }}', {{ claim.get('claim_index', loop.index0) }})"
                                id="publish-btn-{{ claim_id }}-{{ claim.get('claim_index', loop.index0) }}">
                            <i class="fas fa-paper-plane me-1"></i>
                            Publish
                        </button>
                        {% elif claim.get('status') == 'failed' %}
                        <button class="btn btn-sm btn-outline-warning" 
                                onclick="retrySingleClaim('{{ claim_id }}', {{ claim.get('claim_index', loop.index0) }})"
                                id="retry-btn-{{ claim_id }}-{{ claim.get('claim_index', loop.index0) }}">
                            <i class="fas fa-redo me-1"></i>
                            Retry
                        </button>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Individual Status Messages -->
                <div id="single-status-{{ claim_id }}-{{ claim.get('claim_index', loop.index0) }}" class="mt-2"></div>
            </div>
            {% endfor %}
        </div>
        
        <!-- Bulk Status Messages -->
        <div id="publish-status-{{ claim_id }}" class="mt-3"></div>
    </div>
</div>
{% else %}
<div class="text-center py-5">
    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
    <h5>No Claims Found</h5>
    <p class="text-muted">Upload a PDF file to extract claims</p>
    <a href="{{ url_for('index') }}" class="btn btn-primary">
        <i class="fas fa-upload me-2"></i>
        Upload File
    </a>
</div>
{% endfor %}

<!-- URL Editor Modal -->
<div class="modal fade" id="urlEditorModal" tabindex="-1" aria-labelledby="urlEditorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="urlEditorModalLabel">Edit URL</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="urlEditorContent">
                    <p>Loading suggestions...</p>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// URL Editor functionality
function showUrlEditor(claimId, claimIndex, urlType, currentUrl, entityType) {
    const modal = new bootstrap.Modal(document.getElementById('urlEditorModal'));
    const content = document.getElementById('urlEditorContent');
    
    // Show loading
    content.innerHTML = '<p>Loading URL suggestions...</p>';
    modal.show();
    
    // Fetch URL suggestions
    fetch(`/api/url-suggestions`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            currentUrl: currentUrl,
            entityType: entityType,
            urlType: urlType
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let html = `
                <div class="mb-3">
                    <label for="customUrl" class="form-label">Current URL:</label>
                    <input type="text" class="form-control" id="currentUrlInput" value="${currentUrl}" readonly>
                </div>
                <div class="mb-3">
                    <label class="form-label">Suggested URLs (click to select):</label>
                    <div class="list-group">
            `;
            
            data.suggestions.forEach((suggestion, index) => {
                html += `
                    <button type="button" class="list-group-item list-group-item-action" onclick="selectSuggestion('${suggestion}')">
                        <div class="d-flex w-100 justify-content-between">
                            <small class="text-muted">${suggestion}</small>
                            <small><i class="fas fa-external-link-alt"></i></small>
                        </div>
                    </button>
                `;
            });
            
            html += `
                    </div>
                </div>
                <div class="mb-3">
                    <label for="customUrl" class="form-label">Or enter a custom URL:</label>
                    <input type="text" class="form-control" id="customUrl" placeholder="https://example.com/entity">
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-primary" onclick="saveUrlChange('${claimId}', ${claimIndex}, '${urlType}')">
                        <i class="fas fa-save me-1"></i>Save Changes
                    </button>
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            `;
            
            content.innerHTML = html;
        } else {
            content.innerHTML = `
                <div class="alert alert-danger">
                    Error loading suggestions: ${data.error}
                </div>
                <div class="mb-3">
                    <label for="customUrl" class="form-label">Enter a custom URL:</label>
                    <input type="text" class="form-control" id="customUrl" value="${currentUrl}">
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-primary" onclick="saveUrlChange('${claimId}', ${claimIndex}, '${urlType}')">
                        <i class="fas fa-save me-1"></i>Save Changes
                    </button>
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            `;
        }
    })
    .catch(error => {
        content.innerHTML = `
            <div class="alert alert-danger">
                Network error: ${error.message}
            </div>
            <div class="mb-3">
                <label for="customUrl" class="form-label">Enter a custom URL:</label>
                <input type="text" class="form-control" id="customUrl" value="${currentUrl}">
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-primary" onclick="saveUrlChange('${claimId}', ${claimIndex}, '${urlType}')">
                    <i class="fas fa-save me-1"></i>Save Changes
                </button>
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            </div>
        `;
    });
}

function selectSuggestion(url) {
    document.getElementById('customUrl').value = url;
    // Highlight the selected suggestion
    document.querySelectorAll('.list-group-item').forEach(item => {
        item.classList.remove('active');
    });
    event.target.closest('.list-group-item').classList.add('active');
}

function saveUrlChange(claimId, claimIndex, urlType) {
    const newUrl = document.getElementById('customUrl').value.trim();
    
    if (!newUrl) {
        alert('Please enter a URL');
        return;
    }
    
    if (!newUrl.startsWith('http://') && !newUrl.startsWith('https://')) {
        alert('URL must start with http:// or https://');
        return;
    }
    
    // Save the URL change
    fetch(`/api/claims/${claimId}/update-url`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            claimIndex: claimIndex,
            urlType: urlType,
            newUrl: newUrl
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update the display
            const displayElement = document.getElementById(`${urlType}-display-${claimId}-${claimIndex}`);
            if (displayElement) {
                displayElement.textContent = newUrl;
            }
            
            // Hide the warning badge since URL has been verified
            const badge = displayElement.parentElement.querySelector('.badge.bg-warning');
            if (badge) {
                badge.style.display = 'none';
            }
            
            // Hide the modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('urlEditorModal'));
            modal.hide();
            
            // Show success message
            const statusDiv = document.getElementById(`single-status-${claimId}-${claimIndex}`);
            if (statusDiv) {
                statusDiv.innerHTML = `
                    <div class="alert alert-success alert-sm py-2">
                        <i class="fas fa-check-circle me-1"></i>URL updated successfully!
                    </div>
                `;
                setTimeout(() => statusDiv.innerHTML = '', 3000);
            }
        } else {
            alert(`Error updating URL: ${data.error}`);
        }
    })
    .catch(error => {
        alert(`Network error: ${error.message}`);
    });
}

// Publish all claims in a document
function publishAllClaims(claimId) {
    const button = event.target.closest('button');
    const statusDiv = document.getElementById(`publish-status-${claimId}`);
    
    // Disable button and show loading
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Publishing All...';
    
    fetch(`/api/claims/${claimId}/publish`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            statusDiv.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle me-2"></i>
                    ${data.message}
                    <br><small>Published: ${data.summary.published_count}, Failed: ${data.summary.failed_count}</small>
                </div>
            `;
            // Reload page to show updated status
            setTimeout(() => location.reload(), 1500);
        } else {
            statusDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Error: ${data.error}
                </div>
            `;
        }
    })
    .catch(error => {
        statusDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-circle me-2"></i>
                Network error: ${error.message}
            </div>
        `;
    })
    .finally(() => {
        // Re-enable button
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-paper-plane me-2"></i>Publish All to LinkedTrust';
    });
}

// Publish a single claim
function publishSingleClaim(claimId, claimIndex) {
    const button = document.getElementById(`publish-btn-${claimId}-${claimIndex}`);
    const statusDiv = document.getElementById(`single-status-${claimId}-${claimIndex}`);
    const claimDiv = document.getElementById(`claim-${claimId}-${claimIndex}`);
    
    // Disable button and show loading
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Publishing...';
    
    fetch(`/api/claims/${claimId}/publish/${claimIndex}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            statusDiv.innerHTML = `
                <div class="alert alert-success alert-sm py-2">
                    <i class="fas fa-check-circle me-1"></i>
                    Published successfully! ID: ${data.linkedtrust_id}
                </div>
            `;
            
            // Update the claim visual status
            claimDiv.className = claimDiv.className.replace('border-info', 'border-success');
            
            // Hide the publish button and show published status
            button.style.display = 'none';
            
            // Update status badge
            const statusBadge = claimDiv.querySelector('.badge');
            if (statusBadge) {
                statusBadge.className = 'badge bg-success';
                statusBadge.innerHTML = '<i class="fas fa-check-circle me-1"></i>Published';
            }
            
            // Add LinkedTrust ID to the claim info
            const claimInfo = claimDiv.querySelector('.flex-grow-1');
            if (claimInfo && !claimInfo.innerHTML.includes('LinkedTrust ID:')) {
                claimInfo.innerHTML += `<br><strong>LinkedTrust ID:</strong> <span class="badge bg-success">${data.linkedtrust_id}</span>`;
                claimInfo.innerHTML += `<br><small class="text-muted">Published: ${new Date().toISOString().slice(0,16).replace('T', ' ')}</small>`;
                
                // Add validation link
                const validationUrl = `https://live.linkedtrust.us/validate?subject=https://live.linkedtrust.us/claims/${data.linkedtrust_id}`;
                claimInfo.innerHTML += `<br><strong>Validation Link:</strong> <a href="${validationUrl}" target="_blank" class="text-primary small">${validationUrl}</a> <button class="btn btn-sm btn-outline-secondary ms-2" onclick="navigator.clipboard.writeText('${validationUrl}').then(() => { this.textContent='Copied!'; setTimeout(() => this.textContent='Copy', 2000); })">Copy</button>`;
            }
            
        } else {
            statusDiv.innerHTML = `
                <div class="alert alert-danger alert-sm py-2">
                    <i class="fas fa-exclamation-circle me-1"></i>
                    Error: ${data.error}
                </div>
            `;
            
            // Update the claim visual status to failed
            claimDiv.className = claimDiv.className.replace('border-info', 'border-danger');
            
            // Change button to retry
            button.innerHTML = '<i class="fas fa-redo me-1"></i>Retry';
            button.className = 'btn btn-sm btn-outline-warning';
            button.onclick = () => retrySingleClaim(claimId, claimIndex);
            
            // Update status badge
            const statusBadge = claimDiv.querySelector('.badge');
            if (statusBadge) {
                statusBadge.className = 'badge bg-danger';
                statusBadge.innerHTML = '<i class="fas fa-times-circle me-1"></i>Failed';
            }
            
            // Add error info to the claim
            const claimInfo = claimDiv.querySelector('.flex-grow-1');
            if (claimInfo && !claimInfo.innerHTML.includes('Error:')) {
                claimInfo.innerHTML += `<br><strong>Error:</strong> <span class="text-danger small">${data.error}</span>`;
                claimInfo.innerHTML += `<br><small class="text-muted">Failed: ${new Date().toISOString().slice(0,16).replace('T', ' ')}</small>`;
            }
        }
    })
    .catch(error => {
        statusDiv.innerHTML = `
            <div class="alert alert-danger alert-sm py-2">
                <i class="fas fa-exclamation-circle me-1"></i>
                Network error: ${error.message}
            </div>
        `;
    })
    .finally(() => {
        // Re-enable button
        button.disabled = false;
    });
}

// Retry a failed claim (same as publish but with different button styling)
function retrySingleClaim(claimId, claimIndex) {
    const button = document.getElementById(`retry-btn-${claimId}-${claimIndex}`);
    const statusDiv = document.getElementById(`single-status-${claimId}-${claimIndex}`);
    const claimDiv = document.getElementById(`claim-${claimId}-${claimIndex}`);
    
    // Reset visual state to draft
    claimDiv.className = claimDiv.className.replace('border-danger', 'border-info');
    
    // Update button to publish state
    button.id = `publish-btn-${claimId}-${claimIndex}`;
    button.className = 'btn btn-sm btn-outline-primary';
    button.innerHTML = '<i class="fas fa-paper-plane me-1"></i>Publish';
    
    // Update status badge
    const statusBadge = claimDiv.querySelector('.badge');
    if (statusBadge) {
        statusBadge.className = 'badge bg-secondary';
        statusBadge.innerHTML = '<i class="fas fa-clock me-1"></i>Draft';
    }
    
    // Remove error information from claim info
    const claimInfo = claimDiv.querySelector('.flex-grow-1');
    if (claimInfo) {
        let html = claimInfo.innerHTML;
        // Remove error lines
        html = html.replace(/<br><strong>Error:<\/strong>.*?<\/span>/g, '');
        html = html.replace(/<br><small class="text-muted">Failed:.*?<\/small>/g, '');
        claimInfo.innerHTML = html;
    }
    
    // Clear status message
    statusDiv.innerHTML = '';
    
    // Now call publish function
    publishSingleClaim(claimId, claimIndex);
}

// Search functionality
document.getElementById('searchInput').addEventListener('input', function(e) {
    const searchQuery = e.target.value;
    const currentUrl = new URL(window.location);
    currentUrl.searchParams.set('search', searchQuery);
    
    // Debounce the search
    clearTimeout(this.searchTimeout);
    this.searchTimeout = setTimeout(() => {
        window.location.href = currentUrl.toString();
    }, 500);
});

// Auto-hide success messages after 3 seconds
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(function() {
        const successAlerts = document.querySelectorAll('.alert-success');
        successAlerts.forEach(alert => {
            if (alert.innerHTML.includes('Published successfully')) {
                alert.style.transition = 'opacity 0.5s';
                alert.style.opacity = '0';
                setTimeout(() => alert.remove(), 500);
            }
        });
    }, 3000);
});
</script>

<style>
/* Custom styles for better UX */
.alert-sm {
    padding: 0.375rem 0.75rem;
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
}

.border-start {
    border-left-width: 4px !important;
}

.btn-publish {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    color: white;
    transition: all 0.3s ease;
}

.btn-publish:hover {
    background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
    color: white;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.btn-publish:disabled {
    background: #6c757d;
    transform: none;
    box-shadow: none;
}

.claim-item {
    transition: all 0.3s ease;
}

.claim-item:hover {
    transform: translateX(2px);
}

.badge {
    font-size: 0.75rem;
}

.nav-tabs .nav-link {
    border: none;
    color: #6c757d;
    font-weight: 500;
}

.nav-tabs .nav-link.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
}

.nav-tabs .nav-link:hover {
    border: none;
    background-color: #f8f9fa;
}

.nav-tabs .nav-link.active:hover {
    background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
}

/* Loading animation */
.fa-spinner {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
{% endblock %}